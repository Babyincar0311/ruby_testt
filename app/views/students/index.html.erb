<h1>Students</h1>

<%= link_to "+ Student", new_student_path %>

<br><br>

<table border="1" cellpadding="5" cellspacing="0" width="100%">
  <thead>
  <tr style="background: #f2f2f2;">
    <th rowspan="2">Code</th>
    <th rowspan="2">Name</th>
    <th rowspan="2">Address</th>
    <th colspan="5">Subjects & Scores</th>
    <th rowspan="2">Actions</th>
  </tr>
  <tr style="background: #e8e8e8;">
    <th>Subject</th>
    <th>Score 1</th>
    <th>Score 2</th>
    <th>Total</th>
    <th>Grade</th>
  </tr>
  </thead>

  <tbody>
  <% @students.each do |student| %>
    <%
      valid_scores = student.student_scores.reject { |score| score.subject.nil? }
      has_scores = valid_scores.any?
      number_of_rows = has_scores ? valid_scores.count : 1
    %>

    <% if has_scores %>
      <% valid_scores.each_with_index do |score, index| %>
        <tr>
          <% if index == 0 %>
            <td rowspan="<%= number_of_rows %>"><%= student.student_code %></td>
            <td rowspan="<%= number_of_rows %>"><%= student.full_name %></td>
            <td rowspan="<%= number_of_rows %>"><%= student.address %></td>
          <% end %>

          <td><%= score.subject.subject_name %></td>
          <td><%= score.score1 %></td>
          <td><%= score.score2 %></td>
          <td><%= (0.3 * score.score1 + 0.7 * score.score2).round(2) %></td>
          <td><%= score.grade %></td>

          <% if index == 0 %>
            <td rowspan="<%= number_of_rows %>">
              <!-- ✅ Sửa path ở đây -->
              <%= link_to "Add Score", new_student_student_score_path(student) %><br>
              <%= link_to "Edit Student", edit_student_path(student) %>
            </td>
          <% end %>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td><%= student.student_code %></td>
        <td><%= student.full_name %></td>
        <td><%= student.address %></td>
        <td colspan="5"><i>No scores yet</i></td>
        <td>
          <!-- ✅ Sửa path ở đây -->
          <%= link_to "Add Score", new_student_student_score_path(student) %>
        </td>
      </tr>
    <% end %>
  <% end %>
  </tbody>
</table>
